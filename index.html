<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="https://bootswatch.com/4/slate/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-resource.min.js"></script>
	<title>ezBiz Milestones Moniter</title>
</head>
<body ng-app="milestonesList" ng-controller="milestonesCtrl">
	<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
	  <a class="navbar-brand" href="#">Navbar</a>
	  <div class="collapse navbar-collapse" id="navbarSupportedContent">
	      <ul class="navbar-nav mr-auto">
		    <li class="nav-item dropdown">
	  	        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	  	          Milestones
	  	        </a>
	  	        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
	  	          <a class="dropdown-item" href="#" ng-repeat="x in milestones" ng-click="loadIssues(x.id)">
	  	          	  {{x.title}}
	  	          	  <span ng-if="x.state == 'active'" class="badge badge-success">Active</span>
	  	          	  <span ng-if="x.state == 'closed'" class="badge badge-warning">Closed</span>
	  	          </a>
	  	        </div>
	  	    </li>
	      </ul>
	  </div>
	  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
	    <span class="navbar-toggler-icon"></span>
	  </button>
	</nav>

	<div ng-if="errorMain" class="alert alert-danger alert-dismissible fade show" role="alert">
	  <strong>Error</strong> {{errorMain}}
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
	    <span aria-hidden="true">&times;</span>
	  </button>
	</div>

	<div ng-if="errorSub" class="alert alert-warning alert-dismissible fade show" role="alert">
	  <strong>Error</strong> {{errorSub}}
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
	    <span aria-hidden="true">&times;</span>
	  </button>
	</div>

	<div class="container" ng-if="issues" style="padding-top: 50px">
		
		<ul class="nav nav-tabs">
		  <li class="nav-item">
		    <a class="nav-link active show" data-toggle="tab" href="#home">Home</a>
		  </li>
		  <li class="nav-item">
		    <a class="nav-link" data-toggle="tab" href="#profile">Profile</a>
		  </li>
		</ul>
		<div id="myTabContent" class="tab-content">
		  <div class="tab-pane fade active show" id="home">
		    <table class="table table-hover">
		      <thead>
		        <tr>
		          <th scope="col">Type</th>
		          <th scope="col">Column heading</th>
		          <th scope="col">Column heading</th>
		          <th scope="col">Column heading</th>
		        </tr>
		      </thead>
		      <tbody>
		        <tr class="table-active">
		          <th scope="row">Active</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		        <tr>
		          <th scope="row">Default</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		        <tr class="table-primary">
		          <th scope="row">Primary</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		        <tr class="table-secondary">
		          <th scope="row">Secondary</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		        <tr class="table-success">
		          <th scope="row">Success</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		        <tr class="table-danger">
		          <th scope="row">Danger</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		        <tr class="table-warning">
		          <th scope="row">Warning</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		        <tr class="table-info">
		          <th scope="row">Info</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		        <tr class="table-light">
		          <th scope="row">Light</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		        <tr class="table-dark">
		          <th scope="row">Dark</th>
		          <td>Column content</td>
		          <td>Column content</td>
		          <td>Column content</td>
		        </tr>
		      </tbody>
		    </table> 
		  </div>
		  <div class="tab-pane fade" id="profile">
		    <p>Food truck fixie locavore, accusamus mcsweeney's marfa nulla single-origin coffee squid. Exercitation +1 labore velit, blog sartorial PBR leggings next level wes anderson artisan four loko farm-to-table craft beer twee. Qui photo booth letterpress, commodo enim craft beer mlkshk aliquip jean shorts ullamco ad vinyl cillum PBR. Homo nostrud organic, assumenda labore aesthetic magna delectus mollit.</p>
		  </div>
		</div>

	</div>

	<div class="row">
	  <div class="col-4">
	  	<div class="list-group">
	  		
	  		<div ng-repeat="y in issues">
		  	  <a href="#" class="list-group-item list-group-item-action active">
		  	    {{y.title}}
		  	    <span ng-repeat="z in y.labels" class="badge badge-info" style="margin-right: 10px">{{z}}</span>
		  	  </a>
	  	  	</div>
	  	</div>
	  </div>
	  <div class="col-2">
	  	<h1>{{count}}</h1>
	  </div>
	</div>

	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

	<script type="text/javascript">
		var private_token = 'zwU6ZuYrAs52ZF729Scs';
		var milestonesApp = angular.module("milestonesList", []); 
		milestonesApp.controller("milestonesCtrl", function($scope, HttpService) {
		    HttpService.getMilestones()
			.then(function(response) {
				var response_data = [];
				angular.forEach(response, function(value, key) {
				  	response_data[key] = {
				  		'id' : value.id,
				  		'title' : value.title,
				  		'state' : value.state,
				  	};
				});
				$scope.milestones = response_data;
			});
			$scope.loadIssues = function (id) {
			    HttpService.getIssues(id)
				.then(function(response) {
					var response_data = [];
					angular.forEach(response, function(value, key) {
					  	response_data[key] = {
					  		'id' : value.id,
					  		'title' : value.title,
					  		'state' : value.state,
					  		'assignee' : value.assignee,
					  		'assignees' : value.assignees,
					  		'author' : value.author,
					  		'labels' : value.labels,
					  	};
					});
					$scope.issues = response_data;

					// $scope.issues = response;
					// $scope.calManPower(response);
				});
			};
			$scope.calManPower = function (title) {
				var matches;
				var count = 0;
				title.forEach(function(element) {
					if(element.title.match(/[^[\]]+(?=])/g)) {
						str = element.title.match(/[^[\]]+(?=])/g)[0];
						strDays = 0;
						if (!isNaN(str)) {
							strDays = parseFloat(str);
							count +=  parseFloat(strDays * 8.5);
						} else if (/h/.test(str) && /[0-9]/.test(str)) {
							count += parseFloat(str);
						} else if (/d/.test(str) && /[0-9]/.test(str)) {
							strDays = parseFloat(str);
							count +=  parseFloat(strDays * 8.5);
						} else {
							$scope.errorSub = "Some issue has not calculated to total time estimation";
						}
					} else {
						$scope.errorMain = "Some issue has not time estimation";
					}
				});
				$scope.count = count;
			}
		});
		milestonesApp.service('HttpService', function($http) {
		  return {
		    getMilestones: function() {
		    return $http.get('https://code.thinkcube.net/api/v4/projects/ezbiz%2Fcore/milestones?private_token=' + private_token)
		       .then(function (response) { return response.data; });
		    },
		    getIssues: function(id) {
		    return $http.get('https://code.thinkcube.net/api/v4/projects/ezbiz%2Fcore/milestones/'+id+'/issues?page=1&per_page=100&private_token=' + private_token)
		       .then(function (response) { return response.data; });
		    }
		  };
		});
	</script>

</body>
</html>